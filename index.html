<script>
  liff.init({ liffId: "2007736327-ZO83VAmo" })
    .then(() => {
      if (!liff.isLoggedIn()) liff.login();
    })
    .catch((err) => alert("❌ LIFF 初始化失敗：" + err));

  function sanitize(obj) {
    if (typeof obj !== 'object' || obj === null) return obj;

    // ✅ 修正圖片網址格式
    if (obj.url && typeof obj.url === 'string') {
      let match = obj.url.match(/https:\/\/lh3\.googleusercontent\.com\/d\/([a-zA-Z0-9_-]+)/);
      if (match) {
        obj.url = `https://lh3.googleusercontent.com/u/0/d/${match[1]}=w1080`;
      }
    }

    // ✅ 正確遞迴處理物件與陣列（不再強制砍空 box）
    for (const key in obj) {
      if (Array.isArray(obj[key])) {
        obj[key] = obj[key].map(sanitize);
      } else if (typeof obj[key] === 'object' && obj[key] !== null) {
        obj[key] = sanitize(obj[key]);
      }
    }

    return obj;
  }

  function sendFlex() {
    const raw = document.getElementById("jsonInput").value.trim();
    const altText = document.getElementById("altTextInput").value || "這是一則 Flex 卡片";

    if (!raw) return alert("⚠️ 請貼上 Flex JSON");

    try {
      let parsed = JSON.parse(raw);
      parsed = sanitize(parsed);

      const message = (
        parsed.type === "flex" && parsed.altText && parsed.contents
      ) ? parsed : { type: "flex", altText: altText, contents: parsed };

      if (!liff.isApiAvailable("shareTargetPicker")) {
        return alert("⚠️ 此裝置不支援分享功能，請改用手機 LINE App 開啟");
      }

      liff.shareTargetPicker([message])
        .then(() => {
          alert("✅ 分享成功！");
          document.getElementById("jsonInput").value = "";
          document.getElementById("altTextInput").value = "";
        })
        .catch((err) => alert("❌ 分享失敗：" + err));
    } catch (e) {
      alert("❌ JSON 格式錯誤，請檢查內容\n\n" + e.message);
    }
  }
</script>
