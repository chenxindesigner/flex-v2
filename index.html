<script>
  liff.init({ liffId: "2007736327-ZO83VAmo" })
    .then(() => {
      if (!liff.isLoggedIn()) liff.login();
    })
    .catch((err) => alert("❌ LIFF 初始化失敗：" + err));

  function deepClean(obj) {
    if (typeof obj !== 'object' || obj === null) return obj;

    // 不再修改圖片 URL

    for (const key in obj) {
      if (Array.isArray(obj[key])) {
        obj[key] = obj[key].map(deepClean).filter(e => e !== null);
      } else if (typeof obj[key] === 'object') {
        obj[key] = deepClean(obj[key]);
      }
    }
    return obj;
  }

  function sendFlex() {
    const raw = document.getElementById("jsonInput").value.trim();
    const altText = document.getElementById("altTextInput").value || "這是一則 Flex 卡片";

    if (!raw) return alert("⚠️ 請貼上 Flex JSON");

    try {
      let parsed = JSON.parse(raw);

      // 如果外層不是完整 flex 結構，自動包一層
      if (!(parsed.type === "flex" && parsed.altText && parsed.contents)) {
        parsed = {
          type: "flex",
          altText: altText,
          contents: parsed
        };
      }

      parsed = deepClean(parsed);

      if (!liff.isApiAvailable("shareTargetPicker")) {
        return alert("⚠️ 此裝置不支援分享功能，請改用手機 LINE App 開啟");
      }

      liff.shareTargetPicker([parsed])
        .then(() => {
          alert("✅ 分享成功！");
          document.getElementById("jsonInput").value = "";
          document.getElementById("altTextInput").value = "";
        })
        .catch((err) => {
          console.error("❌ 分享失敗：", err);
          alert("❌ 分享失敗：" + err.message);
        });
    } catch (e) {
      console.error("❌ JSON 格式錯誤：", e);
      alert("❌ JSON 格式錯誤，請檢查內容\n\n" + e.message);
    }
  }
</script>
